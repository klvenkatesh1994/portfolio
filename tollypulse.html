<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TollyPulse | TFI Banisa Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800;900&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #050505; color: white; }
        .neo-glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <header class="fixed top-0 w-full z-50 px-8 py-6 bg-black/80 backdrop-blur-md flex justify-between items-center border-b border-white/5">
        <h1 class="text-2xl font-black uppercase tracking-tighter">Tolly<span class="text-cyan-400">Pulse</span></h1>
        <div id="status" class="text-[10px] font-bold text-red-500 uppercase tracking-widest">● Disconnected</div>
    </header>

    <main id="firehose" class="pt-32 px-6 space-y-12 pb-40">
        <div id="debug" class="text-[10px] text-slate-500 font-mono mb-4 text-center opacity-50 uppercase tracking-widest">Initializing...</div>
        <div id="loader" class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-400"></div>
        </div>
    </main>

    <script>
        const debug = (msg) => {
            console.log(msg);
            document.getElementById('debug').innerText = msg;
        };

        const SUPABASE_URL = "https://qwcoxloagqjmlfzcugen.supabase.co";
        const SUPABASE_KEY = "sb_publishable_hvT_1U0NpUbueTuf122F_w_wM4pgmVk";
        
        let supabaseClient;
        try {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            debug("Connecting to TFI Pulse Engine...");
        } catch (e) {
            debug("Init Error: " + e.message);
        }

        async function initFirehose() {
            try {
                const { data: movies, error: movieError } = await supabaseClient.from('tollypulse_movies').select('*');
                const { data: cards, error: cardError } = await supabaseClient.from('tollypulse_cards').select('*');

                if (movieError || cardError) {
                    debug("Sync Error: Check Connection");
                    return;
                }

                const container = document.getElementById('firehose');
                container.innerHTML = '<div id="debug" class="text-[10px] text-slate-500 font-mono mb-4 text-center opacity-50 uppercase tracking-widest">Live Sync Active</div>';

                let rowCount = 0;
                movies.forEach(movie => {
                    const movieCards = cards.filter(c => c.movie_id === movie.id);
                    if (movieCards.length === 0) return;
                    rowCount++;

                    const section = document.createElement('section');
                    section.className = 'space-y-4';
                    section.innerHTML = `
                        <div class="flex justify-between items-end px-2">
                            <h2 class="text-3xl font-black italic tracking-tighter">${movie.title.toUpperCase()}</h2>
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">${movie.status}</span>
                        </div>
                        <div class="flex overflow-x-auto gap-4 no-scrollbar pb-4 snap-x">
                            ${movieCards.map(card => `
                                <div class="snap-start flex-shrink-0 w-80 h-48 neo-glass rounded-3xl p-6 border-l-4 ${getBorderColor(card.card_type)} flex flex-col justify-between">
                                    <div class="flex justify-between items-start">
                                        <span class="text-[8px] font-bold uppercase tracking-[0.2em] opacity-50">${card.card_type}</span>
                                        <span class="text-[8px] font-bold uppercase opacity-30">${card.source_platform}</span>
                                    </div>
                                    <p class="text-sm font-semibold leading-snug line-clamp-3">${card.headline}</p>
                                    <div class="flex justify-between items-center text-[8px] font-bold uppercase tracking-widest">
                                        <span class="${card.sentiment_score > 0.7 ? 'text-green-400' : 'text-slate-400'}">Talk: ${Math.round(card.sentiment_score * 100)}%</span>
                                        <span class="opacity-40">${new Date(card.published_at).toLocaleTimeString()}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(section);
                });

                if (rowCount === 0) {
                    container.innerHTML += '<div class="text-center py-20 text-slate-500 uppercase text-xs font-bold tracking-widest">Waiting for first firehose updates...</div>';
                }

                document.getElementById('status').innerText = "● Live Feed Connected";
                document.getElementById('status').className = "text-[10px] font-bold text-green-500 uppercase tracking-widest";

            } catch (e) {
                debug("Fatal Error: " + e.message);
            }
        }

        function getBorderColor(type) {
            switch(type) {
                case 'collection': return 'border-cyan-500';
                case 'gossip': return 'border-purple-500';
                case 'news': return 'border-blue-500';
                case 'media': return 'border-red-500';
                default: return 'border-slate-700';
            }
        }

        supabaseClient.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'tollypulse_cards' }, () => initFirehose()).subscribe();
        initFirehose();
    </script>
</body>
</html>