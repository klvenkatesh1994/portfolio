<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TollyPulse | TFI Banisa Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800;900&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #050505; color: white; }
        .neo-glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .yt-glow { box-shadow: inset 0 0 20px rgba(239, 68, 68, 0.1); }
        .x-glow { box-shadow: inset 0 0 20px rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body>
    <header class="fixed top-0 w-full z-50 px-8 py-6 bg-black/80 backdrop-blur-md flex justify-between items-center border-b border-white/5">
        <h1 class="text-2xl font-black uppercase tracking-tighter">Tolly<span class="text-cyan-400">Pulse</span></h1>
        <div id="status" class="text-[10px] font-bold text-green-500 uppercase tracking-widest flex items-center gap-2">
            <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
            </span>
            Live Feed Connected
        </div>
    </header>

    <main id="firehose" class="pt-32 px-6 space-y-16 pb-40">
        <!-- Movies and Cards will be injected here -->
        <div class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-400"></div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = "https://qwcoxloagqjmlfzcugen.supabase.co";
        const SUPABASE_KEY = "sb_publishable_hvT_1U0NpUbueTuf122F_w_wM4pgmVk";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function getPlatformIcon(platform) {
            const p = platform.toLowerCase();
            if (p.includes('youtube')) return 'ðŸ”´ YT';
            if (p.includes('twitter') || p.includes('x')) return 'ðŸ¦ X';
            return 'ðŸŒ Web';
        }

        function getBorderColor(type) {
            switch(type) {
                case 'collection': return 'border-cyan-500';
                case 'gossip': return 'border-purple-500';
                case 'news': return 'border-blue-500';
                case 'media': return 'border-red-500';
                case 'social': return 'border-sky-400';
                default: return 'border-slate-700';
            }
        }

        async function initFirehose() {
            try {
                const { data: movies } = await supabaseClient.from('tollypulse_movies').select('*');
                const { data: cards } = await supabaseClient.from('tollypulse_cards').select('*').order('published_at', { ascending: false });

                const container = document.getElementById('firehose');
                container.innerHTML = '';

                movies.forEach(movie => {
                    const movieCards = cards.filter(c => c.movie_id === movie.id);
                    if (movieCards.length === 0) return;

                    const section = document.createElement('section');
                    section.className = 'space-y-6';
                    section.innerHTML = `
                        <div class="flex justify-between items-end px-2">
                            <div>
                                <h2 class="text-4xl font-black italic tracking-tighter uppercase leading-none">${movie.title}</h2>
                                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.3em] mt-2">${movie.status} Â· ${movieCards.length} UPDATES</p>
                            </div>
                        </div>
                        <div class="flex overflow-x-auto gap-6 no-scrollbar pb-4 snap-x">
                            ${movieCards.map(card => `
                                <div class="snap-start flex-shrink-0 w-80 h-56 neo-glass rounded-[2rem] p-8 border-l-4 ${getBorderColor(card.card_type)} flex flex-col justify-between hover:scale-[1.02] transition-transform cursor-pointer">
                                    <div class="flex justify-between items-start">
                                        <span class="text-[9px] font-black uppercase tracking-[0.2em] opacity-40">${card.card_type}</span>
                                        <span class="px-2 py-1 rounded-md bg-white/5 text-[8px] font-bold uppercase tracking-widest opacity-60 text-cyan-400">${getPlatformIcon(card.source_platform)}</span>
                                    </div>
                                    <p class="text-base font-bold leading-tight mb-4 line-clamp-4">${card.headline}</p>
                                    <div class="flex justify-between items-center text-[9px] font-bold uppercase tracking-widest">
                                        <div class="flex items-center gap-2">
                                            <div class="w-1.5 h-1.5 rounded-full ${card.sentiment_score > 0.7 ? 'bg-green-500' : 'bg-amber-500'}"></div>
                                            <span class="${card.sentiment_score > 0.7 ? 'text-green-400' : 'text-amber-400'}">Talk: ${Math.round(card.sentiment_score * 100)}%</span>
                                        </div>
                                        <span class="opacity-30">${new Date(card.published_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(section);
                });
            } catch (e) { console.error(e); }
        }

        supabaseClient.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'tollypulse_cards' }, () => initFirehose()).subscribe();
        initFirehose();
    </script>
</body>
</html>